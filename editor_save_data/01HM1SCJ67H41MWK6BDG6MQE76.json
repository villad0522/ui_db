[{"functionNameJP":"プログラム起動","functionNameEN":"startUp","parametersName":["localUrl","isDebug"],"parametersDataType":["string_nullable","boolean"],"returnValue":"void","functionId":"01HM3F8XKW1HFKGW5H7RFMYD0C","beforeCode":"\n","innerCode":"\n    await startUp( localUrl, isDebug );   // 下層の関数を呼び出す\n    //\n    // テーブルを作成する（テーブルの存在を保存するため）\n    try{\n        await runSqlWriteOnly(\n            `CREATE TABLE IF NOT EXISTS table_names (\n                \"table_number\" INTEGER PRIMARY KEY AUTOINCREMENT,\n                \"table_name\" TEXT NOT NULL,\n                \"enable\" INTEGER NOT NULL DEFAULT 1,\n                \"is_system_table\" INTEGER NOT NULL DEFAULT 0,\n                \"created_at\" INTEGER NOT NULL\n            );`,\n            {},\n        );\n    }\n    catch (err) {\n      throw `システム管理用テーブルの作成に失敗しました。${String(err)}`;\n    }\n    await _reload();    // メモリに再読み込み\n","afterCode":""},{"functionNameJP":"インメモリキャッシュを削除する","functionNameEN":"clearCache","parametersName":[],"parametersDataType":[],"returnValue":"void","functionId":"01HM3F9PXH8EXRT7V7N9S28YGF","beforeCode":"\n\n//【グローバル変数】テーブル名を保存するキャッシュ\nlet cacheData1 = {\n    // データの例\n    // \"t2\": \"テーブル名１\",\n    // \"t8\": \"テーブル名２\"\n};\nlet cacheData2 = {\n    // データの例\n    // \"テーブル名１\": \"t2\",\n    // \"テーブル名２\": \"t8\"\n};\n\n//【サブ関数】メモリに再読み込み\nasync function _reload() {\n    let matrix = [];\n    try {\n        matrix = await runSqlReadOnly(\n            `SELECT * FROM table_names WHERE enable = 1;`,\n            {},\n        );\n    }\n    catch (err) {\n        throw `テーブル「table_names」の読み込みに失敗しました。${String(err)}`;\n    }\n    cacheData1 = {};\n    cacheData2 = {};\n    for (const record of matrix) {\n        const tableName = record[\"table_name\"];\n        const tableNumber = Number(record[\"table_number\"]);\n        cacheData1[\"t\" + tableNumber] = tableName;\n        cacheData2[tableName] = \"t\" + tableNumber;\n    }\n}\n\n","innerCode":"\n    await _reload();    // メモリに再読み込み\n    return await clearCache();   // 下層の関数を呼び出す\n","afterCode":""},{"functionNameJP":"テーブルを作成","functionNameEN":"createTable","parametersName":["tableName","isSystemTable"],"parametersDataType":["string","boolean"],"returnValue":{"message":"string","tableId":"string"},"functionId":"01HM3FA7KYR69753F0SEZNV80C","beforeCode":"\n\n","innerCode":"\n    if (cacheData2[tableName]) {\n        throw `テーブル名「${tableName}」は重複しています。`;\n    }\n    const timestamp = new Date().getTime();\n    await runSqlWriteOnly(\n        `INSERT INTO table_names (table_name, is_system_table, created_at)\n            VALUES ( :tableName, :isSystemTable, :createdAt );`,\n        {\n            \":isSystemTable\": isSystemTable,\n            \":tableName\": tableName,\n            \":createdAt\": timestamp,\n        },\n    );\n    const tables = await runSqlReadOnly(\n        `SELECT table_number FROM table_names\n            WHERE table_name = :tableName\n                AND created_at = :createdAt\n            ORDER BY table_number DESC\n            LIMIT 1;`,\n        {\n            \":tableName\": tableName,\n            \":createdAt\": timestamp,\n        },\n    );\n    if(tables.length===0){\n        throw \"追加したはずのテーブルが見つかりません。\";\n    }\n    const tableNumber = tables[0][\"table_number\"];\n    if(isNaN(tableNumber)){\n        throw \"新しく発行されたテーブルIDが見つかりません。\";\n    }\n    const tableId = \"t\" + tableNumber;\n    await createTable( tableId );   // 下層の関数を呼び出す\n    await _reload();    // メモリに再読み込み\n    return {\n        tableId: tableId,\n        message: `テーブル「${tableName}」を作成しました。`,\n    };\n","afterCode":""},{"functionNameJP":"不可逆的にテーブルを削除","functionNameEN":"deleteTable","parametersName":["tableId"],"parametersDataType":["string"],"returnValue":"string","functionId":"01HM3FBB33TCXTHW0Y5B2A3T0H","beforeCode":"\n\n","innerCode":"\n    await runSqlWriteOnly(\n        `DELETE FROM table_names\n            WHERE table_number = :tableNumber\n                AND is_system_table = 0;`,\n        {\n            \":tableNumber\": tableId.replace(\"t\",\"\"),\n        },\n    );\n    await _reload();    // メモリに再読み込み\n    return await deleteTable( tableId );\n","afterCode":""},{"functionNameJP":"テーブルを無効化","functionNameEN":"disableTable","parametersName":["tableId"],"parametersDataType":["string"],"returnValue":"string","functionId":"01HM3FD3PHMXEXSWBE89DSQD17","beforeCode":"\n\n","innerCode":"\n    await runSqlWriteOnly(\n        `UPDATE table_names\n            SET enable = 0\n            WHERE table_number = :tableNumber\n                AND is_system_table = 0;`,\n        {\n            \":tableNumber\": tableId.replace(\"t\",\"\"),\n        },\n    );\n    await _reload();    // メモリに再読み込み\n    return \"テーブルを無効化しました\";\n","afterCode":""},{"functionNameJP":"テーブルを再度有効化","functionNameEN":"enableTable","parametersName":["tableId"],"parametersDataType":["string"],"returnValue":"string","functionId":"01HM3FDGEVNB6J7D839HA262KS","beforeCode":"\n\n","innerCode":"\n    const tables = await runSqlReadOnly(\n        `SELECT *\n            FROM table_names AS t1\n            INNER JOIN table_names AS t2\n                ON t1.table_name = t2.table_name\n            WHERE t2.table_number = :tableNumber\n                AND t1.table_number <> :tableNumber\n                AND t1.enable = 1\n            LIMIT 1;`,\n        {\n            \":tableNumber\": tableId.replace(\"t\",\"\"),\n        },\n    );\n    if(tables.length>=1){\n        const tableName = tables[0][\"table_name\"];\n        throw `テーブル名「${tableName}」は重複しています。`;\n    }\n    await runSqlWriteOnly(\n        `UPDATE table_names\n            SET enable = 1\n            WHERE table_number = :tableNumber;`,\n        {\n            \":tableNumber\": tableId.replace(\"t\",\"\"),\n        },\n    );\n    await _reload();    // メモリに再読み込み\n    return \"テーブルを有効化しました\";\n","afterCode":""},{"functionNameJP":"テーブル名を変更","functionNameEN":"updateTableName","parametersName":["tables"],"parametersDataType":[[{"id":"string","name":"string"}]],"returnValue":"string","functionId":"01HM3JBPT13CTBB9DZYD7HQBFZ","beforeCode":"\n\n","innerCode":"\n    //==========================================================\n    // テーブル名が重複していないか確認する\n    await _reload();\n    const obj = structuredClone(cacheData1);    // ディープコピー\n    // データの例\n    // obj = {\n    //     \"t2\": \"テーブル名１\",\n    //     \"t8\": \"テーブル名２\"\n    // };\n    for (const { id, name } of tables) {\n        obj[id] = name;\n    }\n    // この時点で、連想配列「obj」には、全てのテーブル一覧が格納されている。\n    // データの例\n    // obj = {\n    //     \"2\": \"テーブル名１\",（変更後のテーブル名）\n    //     \"8\": \"テーブル名２\"\n    // };\n    for (const { id, name } of tables) {\n        const newObj = structuredClone(obj);    // ディープコピー\n        //\n        // 自分自身を除いた、他のテーブルと名前が被っていないか確認する\n        delete newObj[id];    //自分自身を除く\n        const tableNameArray = Object.values(newObj);\n        if (tableNameArray.includes(name)) {\n            throw `テーブル名「${name}」は重複しています。`;\n        }\n    }\n    // テーブル名が重複していないか確認する ここまで\n    //==========================================================\n    //\n    for (const { id, name } of tables) {\n        await runSqlWriteOnly(\n            `UPDATE table_names\n                SET table_name = :tableName\n                WHERE table_number = :tableNumber\n                    AND is_system_table = 0;`,\n            {\n                \":tableName\": name,\n                \":tableNumber\": id.replace(\"t\",\"\"),\n            },\n        );\n    }\n    await _reload();    // メモリに再読み込み\n    return \"テーブル名を変更しました\";\n","afterCode":""},{"functionNameJP":"テーブルの一覧を取得","functionNameEN":"listTables","parametersName":["pageNumber_tables","onePageMaxSize","isTrash"],"parametersDataType":["number","number","boolean"],"returnValue":{"tables":[{"id":"string","name":"string"}],"tables_total":"number"},"functionId":"01HM3JXCNA6V88MQG3FHAFSV92","beforeCode":"\n\n","innerCode":"\n    const pageNumber = pageNumber_tables;\n    if (!(pageNumber >= 1)) {\n        pageNumber = 1;\n    }\n    const [{ \"COUNT(*)\": count }] = await runSqlReadOnly(\n        `SELECT COUNT(*)\n            FROM table_names\n            WHERE enable = :isEnable;`,\n        {\n            // 現存するテーブル一覧を取得する場合は１\n            // 削除済みのテーブル一覧を取得する場合は０\n            \":isEnable\": isTrash ? 0 : 1,\n        },\n    );\n    // 「sqlite_master」と結合させることで、実際に存在するテーブルのみに絞り込む\n    const matrix = await runSqlReadOnly(\n        `SELECT\n            ( \"t\" || table_names.table_number ) AS id,\n            table_names.table_name AS name\n        FROM table_names\n        INNER JOIN sqlite_master\n            ON ( \"t\" || table_names.table_number ) = sqlite_master.name\n        WHERE table_names.enable = :isEnable\n            AND table_names.is_system_table = 0\n        ORDER BY table_names.created_at DESC\n        LIMIT :limit OFFSET :offset;`,\n        {\n            // 現存するテーブル一覧を取得する場合は１\n            // 削除済みのテーブル一覧を取得する場合は０\n            \":isEnable\": isTrash ? 0 : 1,\n            \":limit\": onePageMaxSize,\n            \":offset\": onePageMaxSize * (pageNumber - 1),\n        },\n    );\n    return {\n        \"tables\": matrix,\n        \"tables_total\": count,\n    }\n","afterCode":""},{"functionNameJP":"SQLクエリ実行（読み取り専用）","functionNameEN":"runSqlReadOnly","parametersName":["sql","params"],"parametersDataType":["string",{"string":"any"}],"returnValue":[["any"]],"functionId":"01HM3KTENYGV4KKYJANASW5CQM","beforeCode":"\n\n","innerCode":"\n    //入力パラメータに含まれるテーブル名をIDに置き換える\n    for( const tableId in cacheData1 ){\n        const tableName = cacheData1[tableId];\n        sql = sql.replaceAll( tableName, tableId );\n    }\n    return await runSqlReadOnly( sql, params );\n","afterCode":""},{"functionNameJP":"SQLクエリ実行（書き込み専用）","functionNameEN":"runSqlWriteOnly","parametersName":["sql","params"],"parametersDataType":["string",{"string":"any"}],"returnValue":"void","functionId":"01HM3M06JC2EHAXJ77ZM0Q8E7N","beforeCode":"\n\n","innerCode":"\n    //入力パラメータに含まれるテーブル名をIDに置き換える\n    for( const tableId in cacheData1 ){\n        const tableName = cacheData1[tableId];\n        sql = sql.replaceAll( tableName, tableId );\n    }\n    return await runSqlWriteOnly( sql, params );\n","afterCode":"\n"}]